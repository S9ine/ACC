<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.5/font/bootstrap-icons.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
      body { background-color: #e9ecef; font-family: 'Sarabun', sans-serif; }
      .card-job { border-left: 5px solid #28a745; cursor: pointer; transition: 0.2s; }
      .card-job:hover { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
      .no-wo { border-left-color: #dc3545 !important; background-color: #fff5f5; }
      
      .modal-header { background: #198754; color: white; }
      .section-card { background: #fff; border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #dee2e6; }
      .section-title { font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; color: #2c3e50; font-size: 1rem; }
      
      /* ปรับแต่งตารางอะไหล่ */
      .table-spare input { border: none; background: transparent; width: 100%; text-align: center; }
      .table-spare input:focus { outline: 1px solid #86b7fe; background: white; }
      .table-spare td { padding: 4px; vertical-align: middle; }
    </style>
  </head>
  <body>

    <div id="login-page" class="container mt-5" style="max-width: 400px;">
      <div class="card shadow">
        <div class="card-body p-4">
          <h3 class="text-center mb-4 text-success">ACC Maintenance</h3>
          <div class="mb-3">
            <label>Select Team</label>
            <select id="login-team" class="form-select form-select-lg"><option disabled selected>Loading...</option></select>
          </div>
          <div class="mb-3">
            <label>Passcode</label>
            <input type="password" id="login-pass" class="form-control form-control-lg">
          </div>
          <button onclick="doLogin()" class="btn btn-success w-100 btn-lg">Login</button>
        </div>
      </div>
    </div>

    <div id="app-page" style="display:none;">
      <nav class="navbar navbar-dark bg-success mb-3 shadow-sm">
        <div class="container-fluid">
          <span class="navbar-brand mb-0 h1" id="nav-team-name">Team</span>
          <button class="btn btn-outline-light btn-sm" onclick="logout()">Logout</button>
        </div>
      </nav>

      <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5>Job List</h5>
          <button class="btn btn-primary shadow-sm" onclick="openModal()">
            <i class="bi bi-plus-circle-fill"></i> New Job
          </button>
        </div>

        <div class="row mb-3 text-center g-2">
           <div class="col-6"><div class="p-2 bg-white rounded border shadow-sm">In Progress: <span id="count-progress" class="fw-bold text-warning">0</span></div></div>
           <div class="col-6"><div class="p-2 bg-white rounded border shadow-sm">Completed: <span id="count-completed" class="fw-bold text-success">0</span></div></div>
        </div>
        <div id="job-list-container" class="row g-3"></div>
      </div>
    </div>

    <div class="modal fade" id="jobModal" tabindex="-1" data-bs-backdrop="static">
      <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content" style="background-color: #f8f9fa;">
          <div class="modal-header">
            <h5 class="modal-title" id="modalTitle">ACC Maintenance Confirmation</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="jobForm">
              <input type="hidden" id="jobId">
              
              <div class="row">
                <div class="col-md-7">
                  <div class="section-card">
                    <div class="section-title"><i class="bi bi-person-badge-fill"></i> Supervisor Information</div>
                    <div class="row g-2 mb-2">
                      <div class="col-4">
                        <label class="form-label small fw-bold">User ID</label>
                        <input type="text" id="userId" class="form-control form-control-sm" placeholder="ID">
                      </div>
                      <div class="col-8">
                        <label class="form-label small fw-bold">Name</label>
                        <select id="supervisor" class="form-select form-select-sm" required></select>
                      </div>
                    </div>
                    <div class="row g-0 text-center border rounded overflow-hidden">
                      <div class="col-4 bg-light py-1 border-end border-bottom small fw-bold">Type</div>
                      <div class="col-4 bg-light py-1 border-end border-bottom small fw-bold">Start</div>
                      <div class="col-4 bg-light py-1 border-bottom small fw-bold">Finish</div>
                      
                      <div class="col-4 py-1 border-end small">Plan</div>
                      <div class="col-4 border-end"><input type="time" id="planStart" class="form-control form-control-sm border-0 text-center" value="08:00"></div>
                      <div class="col-4"><input type="time" id="planFinish" class="form-control form-control-sm border-0 text-center" value="17:00"></div>
                      
                      <div class="col-12 border-top"></div>
                      <div class="col-4 py-1 border-end small bg-white">Actual</div>
                      <div class="col-4 border-end"><input type="time" id="actualStart" class="form-control form-control-sm border-0 text-center text-danger fw-bold"></div>
                      <div class="col-4"><input type="time" id="actualFinish" class="form-control form-control-sm border-0 text-center text-danger fw-bold"></div>
                    </div>
                  </div>

                  <div class="section-card">
                    <div class="section-title"><i class="bi bi-people-fill"></i> Contractor Information</div>
                    <div class="row g-2 mb-2">
                      <div class="col-4">
                         <select id="contractorType" class="form-select form-select-sm bg-success text-white">
                           <option value="Internal">Internal</option>
                           <option value="External">External</option>
                         </select>
                      </div>
                      <div class="col-6"><input type="text" id="contractorName" class="form-control form-control-sm" placeholder="Contractor Name/Team"></div>
                      <div class="col-2"><input type="number" id="contractorQty" class="form-control form-control-sm" placeholder="Qty"></div>
                    </div>
                  </div>
                </div>

                <div class="col-md-5">
                   <div class="section-card">
                      <div class="section-title"><i class="bi bi-file-earmark-text-fill"></i> Work Order Detail</div>
                      <div class="mb-2">
                         <div class="input-group input-group-sm">
                           <span class="input-group-text fw-bold">WO :</span>
                           <input type="text" id="woNumber" class="form-control bg-light" placeholder="Scan or Enter WO">
                         </div>
                         <div id="wo-warning" class="text-danger small mt-1" style="display:none;">* No WO detected</div>
                      </div>
                      <div class="mb-2">
                         <textarea id="description" class="form-control form-control-sm" rows="3" placeholder="Job Description..." required></textarea>
                      </div>
                      <div class="text-end text-muted small" id="todayDate">Date: ...</div>
                   </div>

                   <div class="section-card">
                      <div class="section-title d-flex justify-content-between">
                         <span><i class="bi bi-tools"></i> Spare Part & Cost</span>
                         <button type="button" class="btn btn-sm btn-outline-success py-0" onclick="addSpareRow()">+ Add Item</button>
                      </div>
                      
                      <div class="border rounded mb-2 bg-light" style="max-height: 150px; overflow-y: auto;">
                        <table class="table table-sm table-spare mb-0 small">
                           <thead>
                             <tr class="text-muted">
                               <th>Item Name</th>
                               <th width="50">Qty</th>
                               <th width="70">Price</th>
                               <th width="20"></th>
                             </tr>
                           </thead>
                           <tbody id="spare-list-body" class="bg-white">
                              </tbody>
                        </table>
                      </div>

                      <div class="input-group input-group-sm">
                        <span class="input-group-text bg-light">Total Cost</span>
                        <input type="number" id="externalCost" class="form-control text-end fw-bold" placeholder="0.00" readonly>
                        <span class="input-group-text">THB</span>
                      </div>
                   </div>

                </div>
              </div>

            </form>
          </div>
          <div class="modal-footer bg-light">
             <div class="d-flex w-100 justify-content-between">
                <div>
                   <button type="button" class="btn btn-secondary btn-sm me-2" data-bs-dismiss="modal">Close</button>
                   <span id="status-indicator" class="badge bg-warning text-dark">In Progress</span>
                </div>
                <div>
                   <button type="button" id="btn-save" class="btn btn-secondary" onclick="submitJob('In Progress')">Save & Dashboard</button>
                   <button type="button" id="btn-confirm" class="btn btn-success" onclick="submitJob('Completed')">Confirm Completed</button>
                </div>
             </div>
          </div>
        </div>
      </div>
    </div>
    
    <?!= include('JavaScript'); ?>
  </body>
</html>
